#!/usr/bin/perl

# Begin-Doc
# Name: pull-host
# Description: pulls host content
# End-Doc

use lib "/local/umrperl/libs";

use Getopt::Long;
use File::Path;

my $debug;
my $help;
my $partial;
my $res = GetOptions(
    "debug+"    => \$debug,
    "partial|p" => \$partial,
    "help|h"    => \$help,
);

my $host = shift @ARGV;

if ( !$res || $help || !$host ) {
    print "Usage: $0 host [--debug] [--partial] [--help]\n";
    exit(1);
}

#
# First determine OS of target system as previously synced
#

#
# Run the sync
#
my @partial = ("-W");
if ($partial) {
    @partial = ();
}

my $base = "/data/hosts/$host";
if ( !-e $base ) {
    mkpath( $base, 0, 0700 ) || die;
}

foreach my $dir ( "/etc", "/home", "/local", "/usr/share/authsrv", "/data", "/var/log" ) {
    my $tname = $dir;
    $tname =~ s|^/||go;
    $tname =~ s|/$||go;
    $tname =~ s|/|-|go;

    print "Syncing $host:$dir\n";

    my @cmd
        = ( "rsync", "-av", @partial, "--force", "--delete", "--progress", "root\@$host:$dir/" => "$base/$tname/" );
    print "+ ", join( " ", @cmd ), "\n";
    system(@cmd);
}