#!/usr/bin/perl

# Begin-Doc
# Name: restore-to-host
# Description: restores host content
# End-Doc

use strict;
use lib "/local/perllib/libs";
use lib "/local/mstperl/libs";

use Getopt::Long;
use File::Path;

my $debug;
my $help;
my $partial;
my $force;
my $res = GetOptions(
    "debug+"    => \$debug,
    "force+"    => \$force,
    "partial|p" => \$partial,
    "help|h"    => \$help,
);

my $host = shift @ARGV;

if ( !$res || $help || !$host ) {
    print "Usage: $0 host [--debug] [--partial] [--help]\n";
    exit(1);
}

my ($full) = gethostbyname($host);
if ( $full && $full ne $host ) {
    print "Overriding hostname with: $full\n";
    $host = $full;
}

unlink("/root/.ssh/known_hosts");

#
# Check to see if krb5 authenticated
#
if ( !-e "/root/.ssh/id_dsa" && !-e "/root/.ssh/id_rsa" ) {
    my $saw_krb = 0;
    open( my $in, "-|" ) || exec("klist");
    while ( defined( my $line = <$in> ) ) {
        chomp($line);
        if ( $line =~ /Default principal: (.*\@.*)/io ) {
            $saw_krb = $1;
        }
    }
    close($in);
    if ( !$saw_krb ) {
        print "Must kinit first in order to have ssh access to targets.\n";
        exit;
    }
    print "Authenticated as: $saw_krb\n";
}

#
# Make sure, this is destructive
#
$| = 1;
if ( !$force ) {
    print "Before proceeding with this, be sure that you have already created\n";
    print "and mounted any /local or /data filesystems, and that you have\n";
    print "enlarged root fs as needed.\n\n";

    print "Overwrite contents of $host? Are you sure (yes/no)? ";
    chomp( my $ans = <STDIN> );
    if ( lc($ans) ne "yes" ) {
        print "Exiting!\n";
        exit(1);
    }
}

#
# Rotate through previous sync logs
#
my $logbase  = "/data/hosts/$host/upgsync-logs/restore";
my $logcount = 5;
unlink( $logbase . "." . $logcount );
for my $i ( reverse( 1 .. $logcount - 1 ) ) {
    if ( -e $logbase . "." . $i ) {
        my $nextlog = $logbase . "." . ( $i + 1 );
        rename( $logbase . "." . $i, $nextlog );
    }
}
rename( $logbase, $logbase . ".1" );

open( STDOUT, "|tee $logbase" );
open( STDERR, ">&STDOUT" );

#
# First determine OS of target system as previously synced
#

sub mysystem {
    my @cmd = @_;
    print "+ ", join( " ", @cmd ), "\n";
    system(@cmd);
}

my $base = "/data/hosts/$host";
my @rsync = ( "rsync", "-avHW", "--force", "--delete", "--progress" );

# SSH host keys
my @files = glob("$base/etc/ssh/*key*");
&mysystem( "scp",  @files,         "root\@$host:/etc/ssh/" );
&mysystem( @rsync, "$base/local/", "root\@$host:/local/" );
&mysystem( "ssh", "root\@$host", "service", "sshd", "restart" );
unlink("/root/.ssh/known_hosts");

sleep(2);

if ( -d "$base/data" ) {
    &mysystem( @rsync, "$base/data/", "root\@$host:/data/" );
}

&mysystem( @rsync, "$base/root/.ssh/",   "root\@$host:/root/.ssh/" );
&mysystem( @rsync, "$base/root/.my.cnf", "root\@$host:/root/.my.cnf" );

&mysystem( @rsync, "$base/usr-share-authsrv/", "root\@$host:/usr/share/authsrv/" );

opendir(my $cron, "$base/var-spool-cron");
while ( my $file = readdir($cron) )
{
	next if ( $file eq "." || $file eq ".." || $file eq "root" );
	&mysystem( "scp", "-p", "$base/var-spool-cron/$file", "root\@$host:/var/spool/cron/crontabs/" );
	&mysystem( "ssh", "root\@$host", "chown", "$file:crontab", "/var/spool/cron/crontabs/$file" );
}

# Check for tftp
open( my $in, "$base/etc/xinetd.d/tftp" );
my $data = join( "", <$in> );
close($in);

#if ( $data =~ /^\s*disable\s*=\s*no/gmo ) {
#    print "Found tftp, copying.\n";
#    &mysystem( "scp", "-p", "$base/etc/xinetd.d/tftp", "root\@$host:/etc/xinetd.d/" );
#    &mysystem( "ssh", "root\@$host", "service", "xinetd", "restart" );
#}

# If we have a bonding config
#if ( -e "$base/etc/modprobe.d/bonding.conf" ) {
#    &mysystem( "scp", "-p", "$base/etc/modprobe.d/bonding.conf", "root\@$host:/etc/modprobe.d/" );
#}

# Copy rc-start and rc-stop
&mysystem(
    @rsync,
    "--exclude=rc.000.kernel-config",
    "$base/home/local/adm/rc-start/",
    "root\@$host:/home/local/adm/rc-start/"
);
&mysystem( @rsync, "$base/home/local/adm/rc-stop/", "root\@$host:/home/local/adm/rc-stop/" );

# If we had apache, update the setup
if ( -e "$base/local/apache" ) {
    print "Setting up apache.\n";
    &mysystem( "ssh", "root\@$host", "/local/apache/setup-local-dirs" );
}

# If we had memcache, update the setup
if ( -e "$base/local/memcache" ) {
    print "Setting up memcached.\n";
    &mysystem( "ssh", "root\@$host", "/local/memcache/setup-local-dirs" );
}

# If we had jdk, update the setup
if ( -e "$base/local/jdk" ) {
    print "Setting up JDK.\n";
    &mysystem( "ssh", "root\@$host", "/local/jdk/setup-local-dirs", "7-64" );
}

# If we have keepalived, update
if ( -e "$base/etc/keepalived/keepalived.conf" ) {
    print "Restoring keepalived.\n";
    &mysystem( "ssh", "root\@$host", "apt-get", "-y", "install", "keepalived" );
    &mysystem( "scp", "$base/etc/keepalived/keepalived.conf", "root\@$host:/etc/keepalived/keepalived.conf" );
    &mysystem( "ssh", "root\@$host", "systemctl", "enable", "keepalived.service" );
}

# If we have eth1 config, massage and copy
if (0) {
    if ( -e "$base/etc/sysconfig/network-scripts/ifcfg-eth1" ) {
        print "Restoring eth1.\n";
        &mysystem(
            "scp",
            "$base/etc/sysconfig/network-scripts/ifcfg-eth1",
            "root\@$host:/etc/sysconfig/network-scripts/ifcfg-ens224"
        );
        &mysystem(
            "scp",
            "$base/etc/sysconfig/network-scripts/eth1.route",
            "root\@$host:/etc/sysconfig/network-scripts/ens224.route"
        );
        &mysystem( "ssh", "root\@$host", "perl", "-pi", "-e", "s/eth1/ens224/go",
            "/etc/sysconfig/network-scripts/ifcfg-ens224" );
    }

    # If we have eth2 config, massage and copy
    if ( -e "$base/etc/sysconfig/network-scripts/ifcfg-eth2" ) {
        print "Restoring eth2.\n";
        &mysystem(
            "scp",
            "$base/etc/sysconfig/network-scripts/ifcfg-eth2",
            "root\@$host:/etc/sysconfig/network-scripts/ifcfg-ens256"
        );
        &mysystem(
            "scp",
            "$base/etc/sysconfig/network-scripts/eth2.route",
            "root\@$host:/etc/sysconfig/network-scripts/ens256.route"
        );
        &mysystem( "ssh", "root\@$host", "perl", "-pi", "-e", "s/eth2/ens256/go",
            "/etc/sysconfig/network-scripts/ifcfg-ens256" );
    }

    # If we have eth3 config, massage and copy
    if ( -e "$base/etc/sysconfig/network-scripts/ifcfg-eth3" ) {
        print "Restoring eth3.\n";
        &mysystem(
            "scp",
            "$base/etc/sysconfig/network-scripts/ifcfg-eth3",
            "root\@$host:/etc/sysconfig/network-scripts/ifcfg-ens161"
        );
        &mysystem(
            "scp",
            "$base/etc/sysconfig/network-scripts/eth3.route",
            "root\@$host:/etc/sysconfig/network-scripts/ens161.route"
        );
        &mysystem( "ssh", "root\@$host", "perl", "-pi", "-e", "s/eth3/ens161/go",
            "/etc/sysconfig/network-scripts/ifcfg-ens161" );
    }

    # If we have eth4 config, massage and copy
    if ( -e "$base/etc/sysconfig/network-scripts/ifcfg-eth4" ) {
        print "Restoring eth4.\n";
        &mysystem(
            "scp",
            "$base/etc/sysconfig/network-scripts/ifcfg-eth4",
            "root\@$host:/etc/sysconfig/network-scripts/ifcfg-ens193"
        );
        &mysystem(
            "scp",
            "$base/etc/sysconfig/network-scripts/eth4.route",
            "root\@$host:/etc/sysconfig/network-scripts/ens193.route"
        );
        &mysystem( "ssh", "root\@$host", "perl", "-pi", "-e", "s/eth4/ens193/go",
            "/etc/sysconfig/network-scripts/ifcfg-ens193" );
    }
}

# Check if any autofs usage
open( my $in, "$base/etc/auto.master" );
my $data = join( "", <$in> );
close($in);

if ( -e "$base/etc/keepalived/keepalived.conf" ) {
    &mysystem( "scp", "-p", "$base/etc/keepalived/keepalived.conf", "root\@$host:/etc/keepalived/" );
    &mysystem( "ssh", "root\@$host", "update-rc.d", "keepalived", "enable" );
}

if ( $data =~ m|^/auto| ) {
    print "Found autofs usage, copying auto.master and auto.map, enabling nfs client.\n";
    &mysystem( "scp", "-p", "$base/etc/auto.master", "root\@$host:/etc/" );
    &mysystem( "scp", "-p", "$base/etc/auto.map",    "root\@$host:/etc/" );

    foreach my $svc ( "rpcbind", "nfs-idmap", "nfs-lock", "autofs" ) {
        &mysystem( "ssh", "root\@$host", "systemctl", "enable", "$svc.service" );
        &mysystem( "ssh", "root\@$host", "systemctl", "start",  "$svc.service" );
    }
}

# Check if any exports
open( my $in, "$base/etc/exports" );
my $data = join( "", <$in> );
close($in);

if ( $data =~ m|^/|sgmo ) {
    print "Found exports, copying and enabling nfs server.\n";
    &mysystem( "scp", "-p", "$base/etc/exports", "root\@$host:/etc/" );

    foreach my $svc ( "rpcbind", "nfs-kernel-server" ) {
        &mysystem( "ssh", "root\@$host", "systemctl", "enable", "$svc.service" );
        &mysystem( "ssh", "root\@$host", "systemctl", "start",  "$svc.service" );
    }
}

# Updating passwd config/cron/etc
&mysystem( "ssh", "root\@rdist-p1", "/local/rdist/bin/manual-rdist",
    $host, "passwd-merge", "cron-config", "kernel-config", "network-config", "local-perl" );

# Cleanup local user dirs
&mysystem( "ssh", "root\@$host", "rmdir", "--ignore-fail-on-non-empty", "/local/*" );

# If we had mysql, update the setup
if ( -e "$base/local/mysql" ) {
    if ( -e "$base/local/mysql/cluster" ) {
        print "MySQL is a cluster deployment, not auto-upgrading, run setup and upgrade manually.\n";
    }
    else {
        print "Setting up mysql, you will need to start mysql on the host or reboot manually.\n";
        &mysystem( "ssh", "root\@$host", "/local/mysql/setup-local-dirs" );
        &mysystem( "ssh", "root\@$host", "/local/mysql/setup-local-dirs" );
    }
}

